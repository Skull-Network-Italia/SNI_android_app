name: Code Analysis

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  analyze:
    runs-on: self-hosted

    steps:
      # ---- Checkout ----
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          clean: false

      # ---- C / C++ (clang-tidy) ----
      - name: Static analyze C/C++
        shell: powershell
        run: |
          $files = Get-ChildItem -Recurse -Include *.c,*.cpp -ErrorAction SilentlyContinue
          if (-not $files) {
            Write-Host "No C/C++ files found"
            exit 0
          }
          if (Get-Command clang-tidy -ErrorAction SilentlyContinue) {
            clang-tidy $files.FullName --quiet
          } else {
            Write-Host "clang-tidy not installed"
          }

      # ---- CMake configure check ----
      - name: CMake configure check
        shell: powershell
        run: |
          if (Test-Path "sni_app/windows/CMakeLists.txt") {
            Write-Host "Running CMake configure"
            mkdir build-cmake
            Push-Location build-cmake
            cmake ..\sni_app\windows
            Pop-Location
          } else {
            Write-Host "No CMake project found"
          }

      # ---- Dart/Flutter ----
      - name: Flutter analysis
        shell: powershell
        run: |
          if (Test-Path "sni_app/pubspec.yaml") {
            flutter pub get
            flutter analyze
          } else {
            Write-Host "No Flutter project found"
          }

      # ---- HTML ----
      - name: Static HTML analysis
        shell: powershell
        run: |
          $files = Get-ChildItem -Recurse -Include *.html -ErrorAction SilentlyContinue
          if (-not $files) {
            Write-Host "No HTML files found"
            exit 0
          }
          if (Get-Command htmlhint -ErrorAction SilentlyContinue) {
            htmlhint "**/*.html"
          } else {
            Write-Host "htmlhint not installed"
          }
